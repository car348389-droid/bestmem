name: Run Hourly Script

on:
  schedule:
    - cron: "0 */3 * * *"  # –∫–∞–∂–¥—ã–π —á–∞—Å
  workflow_dispatch:
  
permissions:
  contents: write  # ‚úÖ –¥–∞—ë–º –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ —Ä–µ–ø–æ

jobs:
  run-hourly:
    runs-on: ubuntu-latest
    steps:
      - name: üì• –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        uses: actions/checkout@v3
          
      - name: üîß –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ffmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg
        
      - name: üêç –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        run: |
          pip install -r requirements.txt

      - name: üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º donload.py
        run: |
          python download_video.py

      - name: üíæ –ö–æ–º–º–∏—Ç–∏–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—É—é –±–∞–∑—É
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add videos.db
          git commit -m "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –≤–∏–¥–µ–æ [skip ci]" || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
          git push
          
      - name: üì¶ –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
        uses: actions/upload-artifact@v4
        with:
          name: edited-video
          path: main.mp4
          overwrite: true
          
      - name: üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º edit.py
        run: |
          python edit_video.py

      - name: üì¶ –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
        uses: actions/upload-artifact@v4
        with:
          name: edited-video
          path: res.mp4
          overwrite: true
          
      - name: üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º upload.py
        run: |
          python upload_video.py

      - name: üíæ –ö–æ–º–º–∏—Ç–∏–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—É—é –±–∞–∑—É
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add videos.db
          git commit -m "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –≤–∏–¥–µ–æ [skip ci]" || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
          git push

      - name: üßπ –£–¥–∞–ª—è–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç edited-video
        if: always()
        run: |
          artifact_id=$(gh api repos/${{ github.repository }}/actions/artifacts --paginate -q '.artifacts[] | select(.name=="edited-video") | .id')
          if [ -n "$artifact_id" ]; then
            gh api -X DELETE repos/${{ github.repository }}/actions/artifacts/$artifact_id
            echo "–ê—Ä—Ç–µ—Ñ–∞–∫—Ç edited-video —É–¥–∞–ª—ë–Ω."
          else
            echo "–ê—Ä—Ç–µ—Ñ–∞–∫—Ç edited-video –Ω–µ –Ω–∞–π–¥–µ–Ω."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

