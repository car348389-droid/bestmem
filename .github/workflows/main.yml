name: Run Hourly Script

on:
  schedule:
    - cron: "0 */3 * * *"  # –∫–∞–∂–¥—ã–π —á–∞—Å
  workflow_dispatch:
  
permissions:
  contents: write
  actions: write   # ‚úÖ –Ω—É–∂–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞–º–∏ —á–µ—Ä–µ–∑ API


jobs:
  run-hourly:
    runs-on: ubuntu-latest
    steps:
      - name: üì• –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        uses: actions/checkout@v3
          
      - name: üîß –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ffmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg
        
      - name: üêç –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        run: |
          pip install -r requirements.txt

      - name: üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º donload.py
        run: |
          python download_video.py

      - name: üíæ –ö–æ–º–º–∏—Ç–∏–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—É—é –±–∞–∑—É
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add videos.db
          git commit -m "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –≤–∏–¥–µ–æ [skip ci]" || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
          # –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –¥–µ–ª–∞–µ–º rebase
          git pull --rebase origin main
          git push

          
      - name: üì¶ –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
        uses: actions/upload-artifact@v4
        with:
          name: edited-video
          path: main.mp4
          overwrite: true
          
      - name: üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º edit.py
        run: |
          python edit_video.py

      - name: üì¶ –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
        uses: actions/upload-artifact@v4
        with:
          name: edited-video
          path: res.mp4
          overwrite: true
          
      - name: üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º upload.py
        run: |
          python upload_video.py

      - name: üíæ –ö–æ–º–º–∏—Ç–∏–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—É—é –±–∞–∑—É
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add videos.db
          git commit -m "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –≤–∏–¥–µ–æ [skip ci]" || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
          # –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –¥–µ–ª–∞–µ–º rebase
          git pull --rebase origin main
          git push


      - name: üßπ –£–¥–∞–ª—è–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç edited-video
        if: always()
        run: |
          echo "üîç –ò—â–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç edited-video..."
          artifact_ids=$(gh api -X GET "repos/${{ github.repository }}/actions/artifacts" --jq '.artifacts[] | select(.name=="edited-video") | .id')
      
          echo "$artifact_ids" | while read -r artifact_id; do
            if [ -n "$artifact_id" ]; then
              echo "üóëÔ∏è –£–¥–∞–ª—è–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç ID=$artifact_id"
              gh api -X DELETE "repos/${{ github.repository }}/actions/artifacts/$artifact_id"
              echo "‚úÖ –ê—Ä—Ç–µ—Ñ–∞–∫—Ç $artifact_id —É–¥–∞–ª—ë–Ω."
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

